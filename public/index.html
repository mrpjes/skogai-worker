<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vedrik – Skog & lite AI</title>

  <!-- PDF.js (legacy för iOS Safari) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/legacy/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/legacy/build/pdf.worker.min.js";
  </script>

  <style>
    :root{
      --bg:#0b0f0c;
      --panel:#0e140f;
      --card:#111613e6;
      --muted:#a7b0aa;
      --text:#eef3ef;
      --accent:#66d28c;
      --accent-2:#51a8ff;
      --accent-3:#f2b94c;
      --border:#1d241f;
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.45 ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
    }

    /* Hero */
    .hero{
      position:relative;
      min-height:26vh;           /* mindre luft i överkant */
      display:grid;
      place-items:start start;   /* texten högre upp */
      padding:16px 24px;         /* kompaktare padding */
      background:#0b0f0c url("/forest.jpg") center/cover no-repeat;
      isolation:isolate;
    }
    .hero::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.08) 0%, rgba(0,0,0,.45) 60%, rgba(11,15,12,.9) 100%);
      z-index:0;
    }
    .hero-inner{ position:relative; z-index:1; max-width:1200px; width:100%; margin:0 auto; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px; color:#eaf7ef; margin-bottom:4px; text-shadow:0 2px 14px rgba(0,0,0,.35); }
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(102,210,140,.18)}
    h1{ margin:0 0 4px 0; font-size:clamp(26px,4vw,40px); line-height:1.1; text-shadow:0 2px 14px rgba(0,0,0,.35); }
    .sub{ margin:0; color:#dfe7e1; opacity:.9 }

    /* Main layout */
    .wrap{
      max-width:1200px;
      margin:-36px auto 72px;    /* drar upp innehållet lite */
      padding:0 24px;
      display:grid; grid-template-columns: 1.05fr 1.4fr; gap:18px;
    }
    @media (max-width:1020px){ .wrap{ grid-template-columns:1fr; } }

    .panel{
      background:linear-gradient(180deg, rgba(17,22,19,.95), rgba(17,22,19,.85));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
      padding:16px;
    }
    @media (min-width:1020px){
      aside.panel{ position:sticky; top:16px; align-self:start; height:fit-content; }
    }

    /* Stepper */
    .stepper{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:10px }
    .step{
      display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0f140f;
      color:#dfe7e1; font-weight:600; opacity:.85;
    }
    .step.active{ background:#152018; border-color:#2c3a33; opacity:1 }
    .step.done{ background:#13261a; border-color:#2f5b40; }
    .badge{ display:inline-grid; place-items:center; width:22px; height:22px; border-radius:999px; font-size:12px; background:#0f130f; border:1px solid #2b3530; }
    .done .badge{ background:var(--accent); border-color:#44b86f; color:#071108; }

    /* Cards + common */
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); }
    .card .hd{ padding:14px 16px 0; color:#d9e3dc; display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .card .bd{ padding:14px 16px 18px }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end }
    .row > *{ flex:1 1 220px }

    /* Inputs & buttons */
    .input, .number, .file{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0f140f; color:#fff; outline:none;
    }
    .checkbox{ display:flex; align-items:center; gap:8px; }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid #2a3330;
      background:#152018; color:#e9f6ee; cursor:pointer; font-weight:700;
      transition:.18s transform ease,.18s background ease,.18s border-color ease;
    }
    .btn:hover{ transform:translateY(-1px); background:#17251b; border-color:#31413a }
    .btn.primary{ background:var(--accent); border-color:#44b86f; color:#09110c }
    .btn.primary:hover{ background:#5dd78f }
    .btn.ghost{ background:#0f130f }
    .btn.blue{ background:var(--accent-2); border-color:#2b7dd8; color:#071018 }
    .btn.blue:hover{ background:#59b0ff }

    /* Progress bars */
    .bar{height:10px;background:#0f130f;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>div{height:100%;width:0%}
    #upBar{background:linear-gradient(90deg,#52d18b,#7de0a8)}
    #exBar{background:linear-gradient(90deg,#6fa8ff,#91c2ff)}

    /* Right column dashboard */
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:1020px){ .kpi{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kpi .item{background:#0f140f;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .lbl{font-size:12px;color:var(--muted)}
    .kpi .val{font-weight:800;font-size:18px;margin-top:2px}
    .kpi .val.good{ color:#66d28c; }
    .kpi .val.warn{ color:#f2b94c; }
    .kpi .val.bad{  color:#ff7a7a; }
    .badge-small{
      display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px;
      border:1px solid #284133; margin-left:6px; background:#13261a; color:#b8e5c9;
    }

    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .card2{border:1px solid var(--border);border-radius:12px;background:#0f140f;padding:12px}
    .card2 h4{margin:0 0 6px; cursor:pointer; user-select:none; }
    .card2 .content{ display:none; }
    .card2.open .content{ display:block; }
    .kv{display:flex;justify-content:space-between;gap:8px}

    /* Logg */
    pre{white-space:pre-wrap;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #out{background:#0f130f;border:1px dashed #233027;color:#dfe7e1;border-radius:12px;padding:12px;min-height:120px;max-height:360px;overflow:auto;position:relative}
    #out.collapsed{ max-height:180px; }
    #out.collapsed::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:56px;
      background: linear-gradient(180deg, rgba(15,19,15,0), #0f130f 60%);
    }
    .errbox{margin-top:10px;border:1px solid #4a2a2a;background:#1a0f0f;border-radius:10px;padding:10px;color:#ffb3b3}
    details.block{margin-top:12px;border:1px solid #213026;border-radius:8px;background:#0f140f}
    details.block summary{cursor:pointer;padding:10px 12px;color:#9fb0a6;font-weight:600}
    details.block pre{margin:0;padding:12px;border-top:1px solid #213026;color:#91a198}
  </style>
</head>
<body>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand"><span class="dot"></span>Vedrik – Skog & lite AI</div>
      <h1>Snabbvärdera skogsfastighet med PDF-prospekt</h1>
      <p class="sub">Ladda upp prospektet → justera antaganden → få nyckeltal, lönsamhet och exporter.</p>
    </div>
  </header>

  <!-- MAIN -->
  <main class="wrap">

    <!-- LEFT: Wizard -->
    <aside class="panel">
      <div class="stepper">
        <div id="s1" class="step active"><span class="badge">1</span> Ladda upp</div>
        <div id="s2" class="step"><span class="badge">2</span> Antaganden</div>
        <div id="s3" class="step"><span class="badge">3</span> Resultat</div>
      </div>

      <!-- Step 1 -->
      <section class="card" id="step1">
        <div class="hd"><h3>1) Ladda upp & extrahera</h3></div>
        <div class="bd">
          <div class="row">
            <input id="pdf" class="file" type="file" accept="application/pdf" />
            <button id="btnUpload" class="btn primary">Ladda upp PDF</button>
          </div>

          <div class="row" style="margin-top:8px">
            <div>
              <div class="muted" style="margin-bottom:6px">Uppladdning <span id="upPct" style="float:right">0%</span></div>
              <div class="bar"><div id="upBar"></div></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Extrahering (PDF.js) <span id="exPct" style="float:right">0%</span></div>
              <div class="bar"><div id="exBar"></div></div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">

          <div class="row">
            <label class="checkbox"><input type="checkbox" id="cbSummary" checked style="accent-color:#66d28c">Prioritera “Sammanställning över fastigheten”</label>
            <label class="checkbox"><input type="checkbox" id="cbEarlyPages" checked style="accent-color:#66d28c">Inkludera s.1–3</label>
          </div>

          <div class="row" style="margin-top:8px">
            <div>
              <div class="muted" style="margin-bottom:6px">Min tecken per sida</div>
              <input id="minChars" class="number" type="number" min="80" max="1000" step="10" value="160" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Sidor att läsa (ex. 1-3,5,8-12)</div>
              <input id="pages" class="input" type="text" placeholder="tomt = auto (s.1–3 + Sammanställning)" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="input" style="opacity:.9">Nyckel: <code id="key"></code></div>
            <button class="btn ghost" id="btnClear" type="button">Rensa</button>
          </div>
        </div>
      </section>

      <!-- Step 2 -->
      <section class="card" id="step2" style="margin-top:12px">
        <div class="hd"><h3>2) Antaganden & val av analyser</h3></div>
        <div class="bd">
          <div class="row">
            <div>
              <div class="muted" style="margin-bottom:6px">Analyser</div>
              <label class="checkbox"><input type="checkbox" class="an" value="summary_pack" checked>Sammanfattning</label>
              <label class="checkbox"><input type="checkbox" class="an" value="key_metrics" checked>Nyckeltal</label>
              <label class="checkbox"><input type="checkbox" class="an" value="initial_harvest_taxed" checked>Initial avverkning (skatt)</label>
              <label class="checkbox"><input type="checkbox" class="an" value="loan_sustainability" checked>Lån & skogskonto</label>
              <label class="checkbox"><input type="checkbox" class="an" value="interest_distribution" checked>Räntefördelning</label>
              <label class="checkbox"><input type="checkbox" class="an" value="forward_cashflow_and_debt" checked>Kassaflöde & DSCR (lean)</label>
            </div>

            <div>
              <div class="muted" style="margin-bottom:6px">Antaganden</div>
              <div class="row">
                <label>Pris (SEK/m³sk)
                  <input type="number" id="price_per_m3sk" class="number" step="1" value="350">
                </label>
                <label>Skattesats %
                  <input type="number" id="tax_rate_pct" class="number" step="0.1" value="30">
                </label>
                <label>Skogskontoandel %
                  <input type="number" id="skogskonto_share_pct" class="number" step="1" value="60">
                </label>
              </div>
              <div class="row" style="margin-top:6px">
                <label>Låneandel %
                  <input type="number" id="loan_share_pct" class="number" step="1" value="100">
                </label>
                <label>Ränta %
                  <input type="number" id="interest_rate_pct" class="number" step="0.01" value="5">
                </label>
              </div>
              <div class="row" style="margin-top:6px">
                <label>Räntefördelningsränta %
                  <input type="number" id="interest_distribution_rate_pct" class="number" step="0.01" value="8.62">
                </label>
                <label>Eff. näringsskatt %
                  <input type="number" id="business_tax_effective_pct" class="number" step="0.1" value="45">
                </label>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnProcess" class="btn blue">Kör extraktion + analyser</button>
            <button id="btnExportJSON" class="btn ghost" disabled>Exportera JSON</button>
            <button id="btnExportCSV" class="btn ghost" disabled>Exportera CSV</button>
          </div>

          <!-- Presets -->
          <div class="row" style="margin-top:8px">
            <input id="presetName" class="input" placeholder="Namn på preset (t.ex. Bas 2025-Q3)">
            <button id="btnSavePreset" class="btn">Spara preset</button>
            <select id="presetSelect" class="input"></select>
            <button id="btnLoadPreset" class="btn ghost">Ladda preset</button>
          </div>
        </div>
      </section>
    </aside>

    <!-- RIGHT: Results & dashboard -->
    <section class="panel">
      <section class="card">
        <div class="hd">
          <h3 style="margin:0">Snabböversikt</h3>
          <div id="confWrap"></div>
        </div>
        <div class="bd">
          <div class="kpi" id="kpiBox">
            <div class="item"><div class="lbl">Prisidé</div><div class="val" id="kpiPrice">–</div></div>
            <div class="item"><div class="lbl">Skogsmark (ha)</div><div class="val" id="kpiHa">–</div></div>
            <div class="item"><div class="lbl">Volym totalt (m³sk)</div><div class="val" id="kpiVol">–</div></div>
            <div class="item"><div class="lbl">Volym/ha (m³sk/ha)</div><div class="val" id="kpiVha">–</div></div>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <div class="hd"><h3 style="margin:0">Resultat & logg</h3></div>
        <div class="bd">
          <div id="cards" class="grid-cards" style="margin-bottom:12px"></div>
          <pre id="out" class="collapsed">{ "tips": "1) Ladda upp PDF, 2) Kör extraktion." }</pre>
          <div id="err" class="errbox" style="display:none"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
            <button id="btnToggleLog" class="btn ghost">Visa mer</button>
            <button id="btnCopyJSON" class="btn ghost">Kopiera JSON</button>
          </div>

          <details class="block" style="margin-top:14px">
            <summary>Extraherad text (nedtonad)</summary>
            <pre id="rawText">—</pre>
          </details>
        </div>
      </section>
    </section>

  </main>

  <script>
    // ---------- Hjälp ----------
    const fmt  = new Intl.NumberFormat("sv-SE");
    const fmt2 = new Intl.NumberFormat("sv-SE",{maximumFractionDigits:2});
    const SEK = v => (v==null||!isFinite(v)) ? "–" : fmt.format(Math.round(v)) + " kr";
    const NUM = v => (v==null||!isFinite(v)) ? "–" : fmt2.format(v);
    function setUploadProgress(p){ upPct.textContent=Math.round(p)+'%'; upBar.style.width=p+'%' }
    function setExtractProgress(p){ exPct.textContent=Math.round(p)+'%'; exBar.style.width=p+'%' }
    function parsePageSpec(str){
      if(!str || !str.trim()) return [];
      const out=[]; for(const part of str.split(',')){
        const s=part.trim(); if(!s) continue;
        if(s.includes('-')){ let [a,b]=s.split('-').map(x=>parseInt(x,10));
          if(Number.isFinite(a)&&Number.isFinite(b)){ if(a>b)[a,b]=[b,a]; for(let i=a;i<=b;i++) out.push(i); }
        } else { const n=parseInt(s,10); if(Number.isFinite(n)) out.push(n); }
      }
      return [...new Set(out)];
    }

    // KPI färg (enkla trösklar)
    function setKpiClass(el, val, goodHigh=true, t1=1, t2=0.7){
      el.classList.remove('good','warn','bad');
      const n = Number(val);
      if(!isFinite(n)) return;
      const a = goodHigh ? n : -n;
      el.classList.add(a>t1 ? 'good' : a>t2 ? 'warn' : 'bad');
    }

    // ---------- PDF.js extraktion ----------
    async function extractTextWithPDFJS(arrayBuf, opts){
      const { includeEarlyPages=true, minChars=160, pages=[], preferSummary=true } = opts;
      const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
      const N = pdf.numPages;
      const want = new Set();

      if(includeEarlyPages){ for(let i=1;i<=Math.min(3,N);i++) want.add(i); }
      for(const p of pages){ if(p>=1 && p<=N) want.add(p); }

      const summaryHits = [];
      async function getText(p){
        const page = await pdf.getPage(p);
        const tc   = await page.getTextContent();
        return tc.items.map(it=>it.str).join(" ").replace(/\s+/g," ").trim();
      }

      if(preferSummary){
        for(let i=1;i<=N;i++){
          const t = await getText(i);
          const lc = t.toLowerCase();
          if(lc.includes("sammanställning över fastigheten") || lc.includes("sammanställning av fastigheten")){
            summaryHits.push(i);
          } else if (lc.includes("sammanställning")) {
            summaryHits.push(i);
          }
          setExtractProgress((i/N)*40);
          await new Promise(r=>setTimeout(r,0));
        }
        summaryHits.slice(0,3).forEach(p=>want.add(p));
      }

      const ordered = [...want].sort((a,b)=>a-b);
      const chunks=[];
      for(let i=0;i<ordered.length;i++){
        const p = ordered[i];
        const t = await getText(p);
        if(t.length >= minChars){ chunks.push(`\n\n[SID ${p}]\n${t}`); }
        setExtractProgress(40 + ((i+1)/ordered.length)*60);
        await new Promise(r=>setTimeout(r,0));
      }
      return { text: chunks.join("").trim(), pagesUsed: ordered, totalPages: N };
    }

    function uploadToWorkerWithProgress(file){
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'upload', true);
        xhr.setRequestHeader('Content-Type', 'application/pdf');
        xhr.upload.onprogress = (e) => setUploadProgress(e.lengthComputable ? (e.loaded/e.total)*100 : 50);
        xhr.onload = () => {
          try { const json = JSON.parse(xhr.responseText || '{}');
            if (xhr.status>=200 && xhr.status<300 && json.ok) resolve(json);
            else reject(json);
          } catch(e){ reject(e); }
        };
        xhr.onerror = () => reject(new Error('Nätverksfel vid upload'));
        xhr.send(file);
      });
    }

    // ---------- UI state ----------
    let LAST_TEXT = "";
    let LAST_RESP = null;
    let LAST_PAGES = 0;

    function setOut(o){
      out.textContent = typeof o==='string' ? o : JSON.stringify(o,null,2);
    }
    function setStep(activeIdx){
      const steps=[s1,s2,s3];
      steps.forEach((el,i)=>{
        el.classList.toggle('active', i===activeIdx);
        el.classList.toggle('done', i<activeIdx);
      });
    }

    // ---------- Cards ----------
    function kv(label, value){
      const wrap=document.createElement('div'); wrap.className='kv';
      const a=document.createElement('span'); a.textContent=label;
      const b=document.createElement('span');
      b.textContent=(typeof value==='number')? (Number.isInteger(value)? fmt.format(value) : fmt2.format(value)) : (value??"–");
      const ll = label.toLowerCase();
      if(ll.includes("sek") || ll.includes("pris")) b.textContent = SEK(value);
      wrap.appendChild(a); wrap.appendChild(b); return wrap;
    }
    function collapsibleCard(title, rows, open=false){
      const c=document.createElement('div'); c.className='card2' + (open?' open':'');
      const h=document.createElement('h4'); h.textContent=title; c.appendChild(h);
      const wrap=document.createElement('div'); wrap.className='content';
      rows.forEach(r=>wrap.appendChild(r));
      c.appendChild(wrap);
      h.addEventListener('click', ()=> c.classList.toggle('open'));
      return c;
    }
    function renderCards(resp){
      const root = document.getElementById('cards'); root.innerHTML="";
      const data = resp?.data || {};
      const sp   = resp?.analyses?.summary_pack || {};
      const km   = resp?.analyses?.key_metrics?.nyckeltal || sp?.nyckeltal || {};
      const ln   = sp?.lonsamhet || {};

      // Grunddata
      const gd = sp?.grunddata ?? {
        fastighetsbeteckning: data.fastighetsbeteckning || data.fastighet || null,
        kommun: data.kommun ?? null,
        areal_total_ha: data.areal_total_ha ?? null,
        skogsmark_ha: data.skogsmark_ha ?? null,
        volym_total_m3sk: data.volym_total_m3sk ?? null,
        volym_per_ha_m3sk: data.volym_per_ha_m3sk ?? ((data.volym_total_m3sk && data.skogsmark_ha)? (data.volym_total_m3sk/data.skogsmark_ha): null),
        bonitet: data.bonitet ?? null,
        byggnader: data.byggnader ?? null
      };
      root.appendChild(collapsibleCard("Grunddata", [
        kv("Fastighetsbeteckning", gd.fastighetsbeteckning),
        kv("Kommun", gd.kommun),
        kv("Areal (ha)", gd.areal_total_ha),
        kv("Skogsmark (ha)", gd.skogsmark_ha),
        kv("Volym totalt (m³sk)", gd.volym_total_m3sk),
        kv("Volym/ha (m³sk/ha)", gd.volym_per_ha_m3sk),
        kv("Bonitet (m³/ha/år)", gd.bonitet),
        kv("Byggnader", gd.byggnader?.finns===true ? (gd.byggnader?.typer?.join(", ") || "Ja") : (gd.byggnader?.finns===false ? "Nej" : "Okänt"))
      ], true));

      // Nyckeltal
      root.appendChild(collapsibleCard("Nyckeltal", [
        kv("Prisförväntan (SEK)", km.pris_forvantning_sek),
        kv("Taxeringsvärde (SEK)", km.taxeringsvarde_sek),
        kv("Pris/ha (SEK/ha)", km.pris_per_hektar),
        kv("Pris/m³sk (SEK/m³sk)", km.pris_per_m3sk),
        kv("Tillväxt (m³sk/år)", km.tillvaxt_m3sk_per_ar),
        kv("Tillväxtvärde (SEK/år)", km.tillvaxtvarde_sek_per_ar),
        kv("Kapitaliseringsränta (%)", km.kapitaliseringsranta_pct),
        kv("Andel slutavverkningsbar (%)", km.andel_slutavverkningsbar_pct)
      ]));

      // Lönsamhet – Initial avverkning
      const init = ln.initial_avverkning || {};
      root.appendChild(collapsibleCard("Lönsamhet – Initial avverkning (skatt)", [
        kv("Volym S1+S2 (m³sk)", init.volym_avverkning_m3sk),
        kv("Bruttointäkt (SEK)", init.bruttointakt_sek),
        kv("Skogsavdrag använt (SEK)", init.skogsavdrag_anstalld_sek),
        kv("Skogskonto insättning (SEK)", init.skogskonto_insattning_sek),
        kv("Skatt nu (SEK)", init.skatt_nu_sek),
        kv("Netto idag (SEK)", init.netto_idag_sek),
        kv("Utskjuten skatt skogskonto (SEK)", init.utskjuten_skatt_skogskonto_sek),
        kv("Skogskonto netto (efter framtida skatt)", init.skogskonto_netto_efter_fr_skatt_sek),
        kv("Skuldnedbetalning (% av pris) – netto", init.skuldnedbetalning_andel_av_pris_netto_pct)
      ]));

      // Lån & Skogskonto – bärighet
      const loan = ln.lan_och_skogskonto || {};
      root.appendChild(collapsibleCard("Lån & Skogskonto – bärighet", [
        kv("Initialt lån (SEK)", loan.initial_lan_sek),
        kv("Amortering med netto (SEK)", loan.amortering_med_netto_sek),
        kv("Restskuld (SEK)", loan.restskuld_sek),
        kv("Årlig ränta (SEK)", loan.arlig_ranta_sek),
        kv("Skogskonto netto", loan.skogskonto_netto_efter_fr_skatt_sek),
        kv("År räntor täcks av skogskonto", loan.ar_rante_tackt_av_skogskonto)
      ]));

      // Räntefördelning
      const idist = ln.rantefordelning || {};
      root.appendChild(collapsibleCard("Räntefördelning (positiv)", [
        kv("Kapitalunderlag (SEK)", idist.kapitalunderlag_sek),
        kv("Räntefördelningsränta (%)", idist.rantefordelningsranta_pct),
        kv("Räntefördelningsbelopp (SEK)", idist.rantefordelningsbelopp_sek),
        kv("Skattebesparing (indikativ, SEK)", idist.antagen_skattebesparing_vs_naring_sek)
      ]));

      // Kassaflöde & DSCR
      const fwd = ln.framot_kassaflode_och_skuldbarande || {};
      root.appendChild(collapsibleCard("Kassaflöde & DSCR (lean)", [
        kv("Årlig tillväxt (m³sk)", fwd.arlig_tillvaxt_m3sk),
        kv("Årlig intäkt (SEK)", fwd.arlig_intakt_sek),
        kv("Lånekapacitet (SEK)", fwd.lanekapacitet_sek),
        kv("DSCR vs. givet lån", fwd.dscr_vs_given_loan),
        kv("DSCR vs. prisförväntan", fwd.dscr_vs_ask_price)
      ]));
    }

    // ---------- Event handlers ----------
    async function onUpload(){
      const f = pdf.files[0];
      if(!f){ alert('Välj en PDF först'); return; }
      setStep(0);
      setUploadProgress(0); setExtractProgress(0);
      setOut('Laddar upp till R2 ...'); err.style.display='none'; err.textContent='';
      let up;
      try{ up = await uploadToWorkerWithProgress(f); }
      catch(e){ setOut({ok:false, steg:'upload', error:String(e)}); return; }
      key.textContent = up.key;

      try{
        setOut('Extraherar text lokalt (PDF.js) ...');
        const opts = {
          includeEarlyPages: cbEarlyPages.checked,
          preferSummary: cbSummary.checked,
          minChars: Number(minChars.value)||160,
          pages: parsePageSpec(pages.value)
        };
        const ab = await f.arrayBuffer();
        const { text, pagesUsed, totalPages } = await Promise.race([
          extractTextWithPDFJS(ab, opts),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error('PDF.js timeout')),20000))
        ]);
        LAST_TEXT = text||"";
        LAST_PAGES = (pagesUsed||[]).length;
        rawText.textContent = LAST_TEXT || "(tom)";
        setOut({ steg:"upload+extract", key: up.key, extracted_chars:(text||"").length, pages_used: pagesUsed, total_pages: totalPages });

        // Confidence badge
        const chars = (LAST_TEXT||"").length;
        const hasSummary = /sammanställning/i.test(LAST_TEXT);
        const conf = Math.max(0, Math.min(1, (chars/Math.max(1,LAST_PAGES*1200)) * (hasSummary?1.2:1.0)));
        const wrap = document.getElementById('confWrap');
        wrap.innerHTML = `<span class="badge-small">Confidence: ${(conf*100|0)}%</span>`;

        setStep(1);
      }catch(e){
        LAST_TEXT = "";
        setExtractProgress(100);
        setOut({ steg:"upload (ingen lokal text – försök igen)", error:String(e) });
      }
    }

    function pctToDec(p){ return (p==null) ? null : (p/100); }
    function getNum(id){ const v = Number(document.getElementById(id).value); return Number.isFinite(v) ? v : null; }

    async function onProcess(){
      const k=key.textContent.trim(); if(!k){ alert('Ladda upp först'); return; }
      const analyses=[...document.querySelectorAll('.an:checked')].map(x=>x.value);
      // Viktigt: skicka loan_amount_sek: null för backend-kompatibilitet
      const options = {
        price_per_m3sk: getNum('price_per_m3sk') ?? null,
        tax_rate_pct: pctToDec(getNum('tax_rate_pct')) ?? 0.30,
        skogskonto_share_pct: pctToDec(getNum('skogskonto_share_pct')) ?? 0.60,
        loan_share_pct: pctToDec(getNum('loan_share_pct')) ?? 1.0,
        interest_rate_pct: pctToDec(getNum('interest_rate_pct')) ?? 0.05,
        interest_distribution_rate_pct: pctToDec(getNum('interest_distribution_rate_pct')) ?? 0.0862,
        business_tax_effective_pct: pctToDec(getNum('business_tax_effective_pct')) ?? 0.45,
        loan_amount_sek: null // <-- nyckeln finns kvar, inget UI-fält
      };

      setOut('Kör extraktion ...'); err.style.display='none'; err.textContent='';
      const r=await fetch('process',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ key:k, analyses, text: LAST_TEXT || null, options })
      });
      const json = await r.json();
      LAST_RESP = json;

      // Visa ev. felmeddelanden snyggt
      const possibleErrors = json?.error || json?.errors || json?.analyses?.errors;
      if(possibleErrors){
        err.style.display='block';
        err.textContent = typeof possibleErrors==='string' ? possibleErrors : JSON.stringify(possibleErrors,null,2);
      }

      setOut(json);
      renderCards(json);
      btnExportJSON.disabled = false;
      btnExportCSV.disabled = false;

      // KPI
      try{
        const data = json?.data||{};
        const km = json?.analyses?.key_metrics?.nyckeltal || {};
        kpiPrice.textContent = SEK(km?.pris_forvantning_sek ?? data?.pris_forvantning_sek);
        kpiHa.textContent    = NUM(data?.skogsmark_ha ?? km?.skogsmark_ha);
        kpiVol.textContent   = NUM(data?.volym_total_m3sk ?? km?.volym_total_m3sk);
        const vha = (data?.volym_per_ha_m3sk!=null)? data.volym_per_ha_m3sk :
                    ((data?.volym_total_m3sk && data?.skogsmark_ha)? data.volym_total_m3sk/data.skogsmark_ha : km?.volym_per_ha_m3sk);
        kpiVha.textContent   = NUM(vha);

        // enkel färg för volym/ha (exempeltrösklar)
        setKpiClass(kpiVha, parseFloat(String(vha).replace(',','.')), true, 220, 180);
      }catch{}
      setStep(2);
    }

    function onExportJSON(){
      if (!LAST_RESP) return;
      const blob = new Blob([JSON.stringify(LAST_RESP, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a  = document.createElement('a');
      a.href = url; a.download = 'vedrik-skog-resultat.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function flattenForCSV(resp){
      const sp = resp?.analyses?.summary_pack;
      const gd = sp?.grunddata ?? resp?.data ?? {};
      const nk = sp?.nyckeltal ?? resp?.analyses?.key_metrics?.nyckeltal ?? {};
      const ln = sp?.lonsamhet ?? {};
      const init = ln.initial_avverkning ?? {};
      const loan = ln.lan_och_skogskonto ?? {};
      const idst = ln.rantefordelning ?? {};
      const fwd  = ln.framot_kassaflode_och_skuldbarande ?? {};

      const row = {
        fastighetsbeteckning: gd.fastighetsbeteckning ?? gd.fastighet ?? "",
        kommun: gd.kommun ?? "",
        areal_total_ha: gd.areal_total_ha ?? "",
        skogsmark_ha: gd.skogsmark_ha ?? "",
        volym_total_m3sk: gd.volym_total_m3sk ?? "",
        volym_per_ha_m3sk: gd.volym_per_ha_m3sk ?? "",
        bonitet: gd.bonitet ?? "",
        pris_forvantning_sek: nk.pris_forvantning_sek ?? "",
        taxeringsvarde_sek: nk.taxeringsvarde_sek ?? "",
        pris_per_hektar: nk.pris_per_hektar ?? "",
        pris_per_m3sk: nk.pris_per_m3sk ?? "",
        tillvaxt_m3sk_per_ar: nk.tillvaxt_m3sk_per_ar ?? "",
        tillvaxtvarde_sek_per_ar: nk.tillvaxtvarde_sek_per_ar ?? "",
        kapitaliseringsranta_pct: nk.kapitaliseringsranta_pct ?? "",
        andel_slutavverkningsbar_pct: nk.andel_slutavverkningsbar_pct ?? "",
        init_volym_m3sk: init.volym_avverkning_m3sk ?? "",
        init_brutto_sek: init.bruttointakt_sek ?? "",
        init_skogsavdrag_sek: init.skogsavdrag_anstalld_sek ?? "",
        init_skogskonto_insattning_sek: init.skogskonto_insattning_sek ?? "",
        init_skatt_nu_sek: init.skatt_nu_sek ?? "",
        init_netto_idag_sek: init.netto_idag_sek ?? "",
        init_utskjuten_skatt_sek: init.utskjuten_skatt_skogskonto_sek ?? "",
        init_skogskonto_netto_efter_fr_skatt_sek: init.skogskonto_netto_efter_fr_skatt_sek ?? "",
        init_skuldnedbetalning_netto_pct: init.skuldnedbetalning_andel_av_pris_netto_pct ?? "",
        loan_initial_sek: loan.initial_lan_sek ?? "",
        loan_amortering_netto_sek: loan.amortering_med_netto_sek ?? "",
        loan_restskuld_sek: loan.restskuld_sek ?? "",
        loan_arlig_ranta_sek: loan.arlig_ranta_sek ?? "",
        loan_ar_rante_tackt_av_skogskonto: loan.ar_rante_tackt_av_skogskonto ?? "",
        idist_kapitalunderlag_sek: idst.kapitalunderlag_sek ?? "",
        idist_ranta_pct: idst.rantefordelningsranta_pct ?? "",
        idist_belopp_sek: idst.rantefordelningsbelopp_sek ?? "",
        idist_skattebesparing_sek: idst.antagen_skattebesparing_vs_naring_sek ?? "",
        fwd_arlig_tillvaxt_m3sk: fwd.arlig_tillvaxt_m3sk ?? "",
        fwd_arlig_intakt_sek: fwd.arlig_intakt_sek ?? "",
        fwd_lanekapacitet_sek: fwd.lanekapacitet_sek ?? "",
        fwd_dscr_vs_loan: fwd.dscr_vs_given_loan ?? "",
        fwd_dscr_vs_ask: fwd.dscr_vs_ask_price ?? ""
      };
      return [row];
    }

    function toCSV(rows){
      if (!rows.length) return "";
      const headers = Object.keys(rows[0]);
      const esc = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).replace(/"/g,'""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      };
      const head = headers.join(",");
      const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\n");
      return head + "\n" + body;
    }
    function onExportCSV(){
      if (!LAST_RESP) return;
      const rows = flattenForCSV(LAST_RESP);
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a  = document.createElement('a');
      a.href = url; a.download = 'vedrik-skog-resultat.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function onClear(){
      key.textContent = "";
      setOut('{ "tips": "1) Ladda upp PDF, 2) Kör extraktion." }');
      rawText.textContent = "—";
      setUploadProgress(0); setExtractProgress(0);
      LAST_TEXT = ""; LAST_RESP = null; LAST_PAGES = 0;
      kpiPrice.textContent="–"; kpiHa.textContent
