<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vedrik Skog och lite AI</title>
  <style>
    body{font:16px/1.45 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 12px}
    h1{margin:0 0 12px}
    fieldset{border:1px solid #ddd;padding:12px 16px;margin:16px 0;border-radius:10px;background:#fff}
    legend{font-weight:700}
    label{display:inline-flex;gap:6px;align-items:center;margin:6px 14px 6px 0}
    input[type=number]{width:120px}
    input[type=text]{width:160px}
    button{padding:10px 14px;border-radius:8px;border:1px solid #bbb;cursor:pointer;background:#fff}
    .row{display:flex;flex-wrap:wrap;gap:16px;align-items:center}
    .bar{height:10px;background:#eee;border-radius:8px;overflow:hidden;margin-top:4px}
    .bar>div{height:100%;width:0%}
    #upBar{background:#4caf50} #exBar{background:#2196f3}
    .small{color:#666;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{border:1px solid #eee;border-radius:10px;padding:10px;background:#fff}
    .card h4{margin:0 0 6px}
    .kv{display:flex;justify-content:space-between;gap:8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#555}
    #out{white-space:pre-wrap;background:#fbfbfb;border:1px solid #eee;padding:12px;border-radius:8px}
    details.block{margin-top:12px;border:1px solid #eee;border-radius:8px;background:#fbfbfb}
    details.block summary{cursor:pointer;padding:10px 12px;color:#555;font-weight:600}
    details.block pre{margin:0;padding:12px;border-top:1px solid #eee;white-space:pre-wrap}
  </style>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/legacy/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/legacy/build/pdf.worker.min.js";
  </script>
</head>
<body>
<h1>Vedrik Skog och lite AI</h1>

<!-- 1) Ladda upp -->
<fieldset>
  <legend>1) Ladda upp PDF</legend>
  <div class="row">
    <input type="file" id="pdf" accept="application/pdf">
    <button id="btnUpload">Ladda upp</button>
    <div>Nyckel: <code id="key"></code></div>
  </div>

  <div style="margin-top:8px">
    <div>Uppladdning: <span id="upPct">0%</span></div>
    <div class="bar"><div id="upBar"></div></div>
  </div>
  <div style="margin-top:8px">
    <div>Extrahering (PDF.js): <span id="exPct">0%</span></div>
    <div class="bar"><div id="exBar"></div></div>
  </div>

  <div style="margin-top:10px" class="row">
    <label><input type="checkbox" id="prefer_summary" checked> Prioritera ”Sammanställning över fastigheten”</label>
    <div>Min tecken/sida: <input type="number" id="min_chars" min="0" value="60"></div>
    <span class="pill">Fångar tabeller och relevanta rubriker – hoppar rena bildsidor</span>
  </div>
</fieldset>

<!-- 2) Analyser -->
<fieldset>
  <legend>2) Välj analyser</legend>
  <div class="row">
    <label><input type="checkbox" class="an" value="summary_pack" checked> Sammanfattning</label>
    <label><input type="checkbox" class="an" value="key_metrics" checked> Nyckeltal</label>
    <label><input type="checkbox" class="an" value="initial_harvest_taxed" checked> Initial avverkning (skatt)</label>
    <label><input type="checkbox" class="an" value="loan_sustainability" checked> Lån & skogskonto</label>
    <label><input type="checkbox" class="an" value="interest_distribution" checked> Räntefördelning</label>
    <label><input type="checkbox" class="an" value="forward_cashflow_and_debt" checked> Kassaflöde & DSCR (lean)</label>
  </div>

  <div class="row" style="margin-top:8px">
    <div>Slice bytes: <input type="number" id="slice" min="120000" max="2000000" step="10000" value="800000"></div>
    <div>Modell:
      <select id="model">
        <option value="gpt-4.1-mini" selected>gpt-4.1-mini</option>
      </select>
    </div>
  </div>
</fieldset>

<!-- 3) Antaganden -->
<fieldset>
  <legend>3) Antaganden</legend>

  <div style="font-weight:600;margin-bottom:6px">Virkespris</div>
  <div class="row">
    <label>Pris (SEK/m³sk): <input type="number" id="price_per_m3sk" step="1" value="350"></label>
    <span class="pill">Konservativt, exkl. moms (indirekta kostnader implicit)</span>
  </div>

  <div style="font-weight:600;margin:10px 0 6px">Skatt</div>
  <div class="row">
    <label>Skattesats %: <input type="number" id="tax_rate_pct" step="0.1" value="30"></label>
    <label>Skogskontoandel %: <input type="number" id="skogskonto_share_pct" step="1" value="60"></label>
  </div>

  <div style="font-weight:600;margin:10px 0 6px">Finans</div>
  <div class="row">
    <label>Låneandel % (av pris): <input type="number" id="loan_share_pct" step="1" value="100"></label>
    <label>Ränta %: <input type="number" id="interest_rate_pct" step="0.01" value="5"></label>
    <label>Testa lån (SEK): <input type="number" id="loan_amount_sek" step="1000"></label>
  </div>

  <div style="font-weight:600;margin:10px 0 6px">Räntefördelning</div>
  <div class="row">
    <label>Räntefördelningsränta %: <input type="number" id="interest_distribution_rate_pct" step="0.01" value="8.62"></label>
    <label>Effektiv näringsskatt %: <input type="number" id="business_tax_effective_pct" step="0.1" value="45"></label>
  </div>

  <div style="margin-top:10px" class="row">
    <button id="btnProcess">Kör extraktion + analyser</button>
    <button id="btnExportJSON" disabled>Exportera JSON</button>
    <button id="btnExportCSV" disabled>Exportera CSV</button>
  </div>
</fieldset>

<h3>Resultat</h3>
<div id="cards" class="grid"></div>

<!-- Diagnostik & rådata (kollapsbart) -->
<h3>Diagnostik</h3>
<div id="diag"></div>

<script>
  let __lastResponse__ = null;
  let __extractedText__ = ""; // för att kunna visa dolt i details

  const setUploadProgress  = p => { document.getElementById('upPct').textContent=Math.round(p)+'%'; document.getElementById('upBar').style.width=p+'%'; };
  const setExtractProgress = p => { document.getElementById('exPct').textContent=Math.round(p)+'%'; document.getElementById('exBar').style.width=p+'%'; };

  function renderDiagnostics(obj){
    const el = document.getElementById('diag');
    const pages = Array.isArray(window.__EXTRACTED_PAGES__) ? window.__EXTRACTED_PAGES__ : [];
    el.innerHTML = `
      <details class="block" open>
        <summary>Extraktion – sammanfattning</summary>
        <pre>${JSON.stringify({
          steg: obj?.steg || undefined,
          key: document.getElementById('key').textContent.trim() || undefined,
          pages_used: obj?.pages_used ?? undefined,
          total_pages: obj?.total_pages ?? undefined,
          selected_pages: pages
        }, null, 2)}</pre>
      </details>

      <details class="block">
        <summary>Extraherad text (PDF.js)</summary>
        <pre>${__extractedText__ ? __extractedText__.slice(0, 50000) : "—"}</pre>
      </details>

      <details class="block">
        <summary>RAW-data (modellens svar)</summary>
        <pre>${obj?.raw ? (typeof obj.raw === 'string' ? obj.raw : JSON.stringify(obj.raw, null, 2)) : "—"}</pre>
      </details>
    `;
  }

  function uploadToWorkerWithProgress(file){
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'upload', true);
      xhr.setRequestHeader('Content-Type', 'application/pdf');
      xhr.upload.onprogress = (e) => setUploadProgress(e.lengthComputable ? (e.loaded/e.total)*100 : 50);
      xhr.onload = () => {
        try { const json = JSON.parse(xhr.responseText || '{}');
          if (xhr.status>=200 && xhr.status<300 && json.ok) resolve(json);
          else reject(json);
        } catch(e){ reject(e); }
      };
      xhr.onerror = () => reject(new Error('Nätverksfel vid upload'));
      xhr.send(file);
    });
  }

  // ---------- Förbättrad PDF.js extrahering ----------
  const SUMMARY_ANCHORS = [
    "sammanställning över fastigheten","sammanstallning over fastigheten",
    "sammanställning","sammanstallning"
  ];
  const IMPORTANT_SECTIONS = [
    "taxeringsvärde","taxeringsvarde","skogsuppgifter","skog och mark",
    "huggningsklass","huggningsklasser","virkesförråd","virkesforrad",
    "bonitet","tillväxt","tillvaxt","areal","arealfördelning","arealfordelning",
    "prisidé","priside","prisförväntan","prisforvantan"
  ];

  function includesAny(hay, arr){
    const s = hay.toLowerCase();
    return arr.some(k => s.includes(k));
  }

  async function extractTextWithPDFJS(arrayBuf){
    const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
    const total = pdf.numPages;

    const minChars = Number(document.getElementById('min_chars')?.value) || 60;
    const preferSummary = document.getElementById('prefer_summary')?.checked !== false;

    const summaryHits = new Set(), importantHits = new Set();

    // Pass 1: identifiera sidor
    for (let p=1; p<=total; p++){
      const page = await pdf.getPage(p);
      const tc   = await page.getTextContent();
      const pageText = tc.items.map(it => it.str).join(" ").replace(/\s+/g," ").trim();

      if (preferSummary && includesAny(pageText, SUMMARY_ANCHORS)) {
        summaryHits.add(p); if (p+1<=total) summaryHits.add(p+1); if (p+2<=total) summaryHits.add(p+2);
      }
      if (includesAny(pageText, IMPORTANT_SECTIONS)) {
        importantHits.add(p);
      }
      setExtractProgress((p/total)*40);
      await new Promise(r=>setTimeout(r,0));
    }

    const toKeep = new Set();
    if (summaryHits.size>0) summaryHits.forEach(p=>toKeep.add(p));
    importantHits.forEach(p=>toKeep.add(p));
    if (toKeep.size===0){ const start=Math.max(1,total-29); for (let p=start; p<=total; p++) toKeep.add(p); }

    // Pass 2: extrahera text från valda sidor
    let text="", used=0;
    const finalPages = Array.from(toKeep).sort((a,b)=>a-b);
    for (const p of finalPages){
      const page = await pdf.getPage(p);
      const tc   = await page.getTextContent();
      const pageText = tc.items.map(it => it.str).join(" ").replace(/\s+/g," ").trim();

      const hasKw = includesAny(pageText, SUMMARY_ANCHORS) || includesAny(pageText, IMPORTANT_SECTIONS);
      if (pageText.length >= minChars || hasKw) {
        text += `\n\n[SID ${p}]\n` + pageText;
        used++;
      }
      const idx = finalPages.indexOf(p)+1;
      setExtractProgress(40 + (idx/finalPages.length)*60);
      await new Promise(r=>setTimeout(r,0));
    }

    window.__EXTRACTED_PAGES__ = finalPages;
    return { text: text.trim(), pagesUsed: used, totalPages: total };
  }

  async function onUpload(){
    const f=document.getElementById('pdf').files[0];
    if(!f){ alert('Välj PDF'); return; }
    setUploadProgress(0); setExtractProgress(0);
    renderDiagnostics({ steg: "upload:start" });

    let upJson;
    try { upJson = await uploadToWorkerWithProgress(f); }
    catch(e){ renderDiagnostics({ steg:'upload:error', error:String(e) }); return; }
    document.getElementById('key').textContent = upJson.key;

    try {
      const arrayBuf = await f.arrayBuffer();
      const { text, pagesUsed, totalPages } = await extractTextWithPDFJS(arrayBuf);
      __extractedText__ = text || "";
      renderDiagnostics({ steg: "upload+extract", key: upJson.key, pages_used: pagesUsed, total_pages: totalPages, raw: "—" });
    } catch (e) {
      __extractedText__ = "";
      setExtractProgress(100);
      renderDiagnostics({ steg:"upload (ingen lokal text, använder slice-fallback)", key: upJson.key, error:String(e), raw:"—" });
    }
  }

  function getNum(id){ const v = Number(document.getElementById(id).value); return Number.isFinite(v) ? v : null; }
  function pctToDec(p){ return (p==null) ? null : (p/100); }

  async function onProcess(){
    const key=document.getElementById('key').textContent.trim(); if(!key) return alert('Ladda upp först');
    const analyses=[...document.querySelectorAll('.an:checked')].map(x=>x.value);
    const slice=Number(document.getElementById('slice').value)||800000;
    const model=document.getElementById('model').value;
    const text=(__extractedText__ && __extractedText__.trim().length>0) ? __extractedText__ : null;

    const options = {
      price_per_m3sk: getNum('price_per_m3sk') ?? null,
      tax_rate_pct: pctToDec(getNum('tax_rate_pct')) ?? 0.30,
      skogskonto_share_pct: pctToDec(getNum('skogskonto_share_pct')) ?? 0.60,
      loan_share_pct: pctToDec(getNum('loan_share_pct')) ?? 1.0,
      interest_rate_pct: pctToDec(getNum('interest_rate_pct')) ?? 0.05,
      interest_distribution_rate_pct: pctToDec(getNum('interest_distribution_rate_pct')) ?? 0.0862,
      business_tax_effective_pct: pctToDec(getNum('business_tax_effective_pct')) ?? 0.45,
      loan_amount_sek: getNum('loan_amount_sek') ?? null
    };

    const r=await fetch('process',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ key, analyses, slice_bytes:slice, model, text, options, pages: window.__EXTRACTED_PAGES__ })
    });
    const json = await r.json();
    __lastResponse__ = json;
    renderCards(json);
    renderDiagnostics(json);

    document.getElementById('btnExportJSON').disabled = false;
    document.getElementById('btnExportCSV').disabled = false;
  }

  // --------- Rendering ----------
  function formatNumber(v){
    if (v === null || v === undefined) return "–";
    if (typeof v !== 'number' || !isFinite(v)) return String(v);
    if (Math.abs(v) >= 1_000_000) return v.toLocaleString('sv-SE', { maximumFractionDigits: 0 });
    if (Math.abs(v) >= 1_000) return v.toLocaleString('sv-SE', { maximumFractionDigits: 0 });
    return v.toLocaleString('sv-SE', { maximumFractionDigits: 2 });
  }
  function kv(label, value){
    const wrap=document.createElement('div'); wrap.className='kv';
    const a=document.createElement('span'); a.textContent=label;
    const b=document.createElement('span'); b.textContent=formatNumber(value);
    wrap.appendChild(a); wrap.appendChild(b); return wrap;
  }
  function card(title, items, extra){
    const c=document.createElement('div'); c.className='card';
    const h=document.createElement('h4'); h.textContent=title; c.appendChild(h);
    items.forEach(el => c.appendChild(el));
    if (extra){
      const h2=document.createElement('h4'); h2.textContent=extra.title; c.appendChild(h2);
      const pre=document.createElement('pre'); pre.textContent=JSON.stringify(extra.obj,null,2); c.appendChild(pre);
    }
    return c;
  }

  function renderCards(resp){
    const root=document.getElementById('cards'); root.innerHTML="";
    const sp = resp?.analyses?.summary_pack;
    const data = resp?.data || {};
    const km  = resp?.analyses?.key_metrics?.nyckeltal;

    // Grunddata
    const gd = sp?.grunddata ?? {
      fastighetsbeteckning: data.fastighetsbeteckning || data.fastighet || null,
      kommun: data.kommun ?? null,
      areal_total_ha: data.areal_total_ha ?? null,
      skogsmark_ha: data.skogsmark_ha ?? null,
      volym_total_m3sk: data.volym_total_m3sk ?? null,
      volym_per_ha_m3sk: data.volym_per_ha_m3sk ?? ((data.volym_total_m3sk && data.skogsmark_ha)? (data.volym_total_m3sk/data.skogsmark_ha): null),
      bonitet: data.bonitet ?? null,
      huggningsklasser: data.huggningsklasser ?? null,
      tradslag_andelar: data.tradslag_andelar ?? null,
      byggnader: data.byggnader ?? null
    };

    root.appendChild(card("Grunddata", [
      kv("Fastighetsbeteckning", gd.fastighetsbeteckning),
      kv("Kommun", gd.kommun),
      kv("Areal (ha)", gd.areal_total_ha),
      kv("Skogsmark (ha)", gd.skogsmark_ha),
      kv("Volym totalt (m³sk)", gd.volym_total_m3sk),
      kv("Volym/ha (m³sk/ha)", gd.volym_per_ha_m3sk),
      kv("Bonitet (m³/ha/år)", gd.bonitet),
      kv("Byggnader", gd.byggnader?.finns === true ? (gd.byggnader?.typer?.join(", ") || "Ja") : (gd.byggnader?.finns === false ? "Nej" : "Okänt"))
    ], gd.huggningsklasser ? {title:"Huggningsklasser (m³sk)", obj: gd.huggningsklasser} : null));

    // Nyckeltal
    const nk = sp?.nyckeltal ?? km ?? {};
    root.appendChild(card("Nyckeltal", [
      kv("Prisförväntan (SEK)", nk.pris_forvantning_sek),
      kv("Taxeringsvärde (SEK)", nk.taxeringsvarde_sek),
      kv("Pris/ha (SEK/ha)", nk.pris_per_hektar),
      kv("Pris/m³sk (SEK/m³sk)", nk.pris_per_m3sk),
      kv("Tillväxt (m³sk/år)", nk.tillvaxt_m3sk_per_ar),
      kv("Tillväxtvärde (SEK/år)", nk.tillvaxtvarde_sek_per_ar),
      kv("Kapitaliseringsränta (%)", nk.kapitaliseringsranta_pct),
      kv("Andel slutavverkningsbar (%)", nk.andel_slutavverkningsbar_pct)
    ]));

    // Lönsamhet
    const ln = sp?.lonsamhet ?? {};
    const init = ln.initial_avverkning;
    const loan = ln.lan_och_skogskonto;
    const idist = ln.rantefordelning;
    const fwd  = ln.framot_kassaflode_och_skuldbarande;

    root.appendChild(card("Lönsamhet – Initial avverkning (skatt)", [
      kv("Volym S1+S2 (m³sk)", init?.volym_avverkning_m3sk),
      kv("Bruttointäkt (SEK)", init?.bruttointakt_sek),
      kv("Skogsavdrag använt (SEK)", init?.skogsavdrag_anstalld_sek),
      kv("Skogskonto insättning (SEK)", init?.skogskonto_insattning_sek),
      kv("Skatt nu (SEK)", init?.skatt_nu_sek),
      kv("Netto idag (SEK)", init?.netto_idag_sek),
      kv("Utskjuten skatt skogskonto (SEK)", init?.utskjuten_skatt_skogskonto_sek),
      kv("Skogskonto netto (efter framtida skatt)", init?.skogskonto_netto_efter_fr_skatt_sek),
      kv("Skuldnedbetalning (% av pris) – netto", init?.skuldnedbetalning_andel_av_pris_netto_pct)
    ]));

    root.appendChild(card("Lån & Skogskonto – bärighet", [
      kv("Initialt lån (SEK)", loan?.initial_lan_sek),
      kv("Amortering med netto (SEK)", loan?.amortering_med_netto_sek),
      kv("Restskuld (SEK)", loan?.restskuld_sek),
      kv("Årlig ränta (SEK)", loan?.arlig_ranta_sek),
      kv("Skogskonto netto", loan?.skogskonto_netto_efter_fr_skatt_sek),
      kv("År räntor täcks av skogskonto", loan?.ar_rante_tackt_av_skogskonto)
    ]));

    root.appendChild(card("Räntefördelning (positiv)", [
      kv("Kapitalunderlag (SEK)", idist?.kapitalunderlag_sek),
      kv("Räntefördelningsränta (%)", idist?.rantefordelningsranta_pct),
      kv("Räntefördelningsbelopp (SEK)", idist?.rantefordelningsbelopp_sek),
      kv("Skattebesparing (indikativ, SEK)", idist?.antagen_skattebesparing_vs_naring_sek)
    ]));

    root.appendChild(card("Kassaflöde & DSCR (lean)", [
      kv("Årlig tillväxt (m³sk)", fwd?.arlig_tillvaxt_m3sk),
      kv("Årlig intäkt (SEK)", fwd?.arlig_intakt_sek),
      kv("Lånekapacitet (SEK)", fwd?.lanekapacitet_sek),
      kv("DSCR vs. givet lån", fwd?.dscr_vs_given_loan),
      kv("DSCR vs. prisförväntan", fwd?.dscr_vs_ask_price)
    ]));
  }

  function onExportJSON(){
    if (!__lastResponse__) return;
    const blob = new Blob([JSON.stringify(__lastResponse__, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a  = document.createElement('a');
    a.href = url; a.download = 'skogai-resultat.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function flattenForCSV(resp){
    const sp = resp?.analyses?.summary_pack;
    const gd = sp?.grunddata ?? resp?.data ?? {};
    const nk = sp?.nyckeltal ?? resp?.analyses?.key_metrics?.nyckeltal ?? {};
    const ln = sp?.lonsamhet ?? {};
    const init = ln.initial_avverkning ?? {};
    const loan = ln.lan_och_skogskonto ?? {};
    const idst = ln.rantefordelning ?? {};
    const fwd  = ln.framot_kassaflode_och_skuldbarande ?? {};

    const row = {
      fastighetsbeteckning: gd.fastighetsbeteckning ?? gd.fastighet ?? "",
      kommun: gd.kommun ?? "",
      areal_total_ha: gd.areal_total_ha ?? "",
      skogsmark_ha: gd.skogsmark_ha ?? "",
      volym_total_m3sk: gd.volym_total_m3sk ?? "",
      volym_per_ha_m3sk: gd.volym_per_ha_m3sk ?? "",
      bonitet: gd.bonitet ?? "",
      pris_forvantning_sek: nk.pris_forvantning_sek ?? "",
      taxeringsvarde_sek: nk.taxeringsvarde_sek ?? "",
      pris_per_hektar: nk.pris_per_hektar ?? "",
      pris_per_m3sk: nk.pris_per_m3sk ?? "",
      tillvaxt_m3sk_per_ar: nk.tillvaxt_m3sk_per_ar ?? "",
      tillvaxtvarde_sek_per_ar: nk.tillvaxtvarde_sek_per_ar ?? "",
      kapitaliseringsranta_pct: nk.kapitaliseringsranta_pct ?? "",
      andel_slutavverkningsbar_pct: nk.andel_slutavverkningsbar_pct ?? "",
      init_volym_m3sk: init.volym_avverkning_m3sk ?? "",
      init_brutto_sek: init.bruttointakt_sek ?? "",
      init_skogsavdrag_sek: init.skogsavdrag_anstalld_sek ?? "",
      init_skogskonto_insattning_sek: init.skogskonto_insattning_sek ?? "",
      init_skatt_nu_sek: init.skatt_nu_sek ?? "",
      init_netto_idag_sek: init.netto_idag_sek ?? "",
      init_utskjuten_skatt_sek: init.utskjuten_skatt_skogskonto_sek ?? "",
      init_skogskonto_netto_efter_fr_skatt_sek: init.skogskonto_netto_efter_fr_skatt_sek ?? "",
      init_skuldnedbetalning_netto_pct: init.skuldnedbetalning_andel_av_pris_netto_pct ?? "",
      loan_initial_sek: loan.initial_lan_sek ?? "",
      loan_amortering_netto_sek: loan.amortering_med_netto_sek ?? "",
      loan_restskuld_sek: loan.restskuld_sek ?? "",
      loan_arlig_ranta_sek: loan.arlig_ranta_sek ?? "",
      loan_ar_rante_tackt_av_skogskonto: loan.ar_rante_tackt_av_skogskonto ?? "",
      idist_kapitalunderlag_sek: idst.kapitalunderlag_sek ?? "",
      idist_ranta_pct: idst.rantefordelningsranta_pct ?? "",
      idist_belopp_sek: idst.rantefordelningsbelopp_sek ?? "",
      idist_skattebesparing_sek: idst.antagen_skattebesparing_vs_naring_sek ?? "",
      fwd_arlig_tillvaxt_m3sk: fwd.arlig_tillvaxt_m3sk ?? "",
      fwd_arlig_intakt_sek: fwd.arlig_intakt_sek ?? "",
      fwd_lanekapacitet_sek: fwd.lanekapacitet_sek ?? "",
      fwd_dscr_vs_loan: fwd.dscr_vs_given_loan ?? "",
      fwd_dscr_vs_ask: fwd.dscr_vs_ask_price ?? ""
    };
    return [row];
  }

  function toCSV(rows){
    if (!rows.length) return "";
    const headers = Object.keys(rows[0]);
    const esc = (v) => {
      if (v === null || v === undefined) return "";
      const s = String(v).replace(/"/g,'""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    };
    const head = headers.join(",");
    const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\n");
    return head + "\n" + body;
  }

  document.getElementById('btnUpload').addEventListener('click', onUpload);
  document.getElementById('btnProcess').addEventListener('click', onProcess);
  document.getElementById('btnExportJSON').addEventListener('click', () => {
    if (!__lastResponse__) return; onExportJSON();
  });
  document.getElementById('btnExportCSV').addEventListener('click', () => {
    if (!__lastResponse__) return;
    const rows = flattenForCSV(__lastResponse__);
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a  = document.createElement('a');
    a.href = url; a.download = 'skogai-resultat.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
