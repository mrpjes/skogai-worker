// src/index.ts
export interface Env {
  skogaiR2bucket: R2Bucket;  // måste matcha wrangler.toml binding
  OPENAI_API_KEY: string;    // sätts som Secret i Cloudflare
  ACCESS_TOKEN?: string;     // valfritt; för att låsa API med header
}

const JSON_HDR = { "content-type": "application/json" } as const;

export default {
  async fetch(req: Request, env: Env): Promise<Response> {
    const url = new URL(req.url);

    // --- CORS ---
    if (req.method === "OPTIONS") {
      return new Response(null, {
        headers: {
          "access-control-allow-origin": "*",
          "access-control-allow-methods": "GET,POST,OPTIONS",
          "access-control-allow-headers": "content-type,x-access-token",
        },
      });
    }

    // --- Healthcheck ---
    if (url.pathname === "/health") return new Response("ok", { status: 200 });

    // (valfritt) kräva hemlig header
    if (env.ACCESS_TOKEN) {
      const t = req.headers.get("x-access-token");
      if (t !== env.ACCESS_TOKEN) return new Response("Forbidden", { status: 403 });
    }

    // UI
    if (url.pathname === "/" && req.method === "GET") {
      return new Response(HTML_PAGE, {
        headers: { "content-type": "text/html; charset=utf-8" },
      });
    }

    // Upload PDF
    if (url.pathname === "/upload" && req.method === "POST") {
      const ct = req.headers.get("content-type") || "";
      if (!ct.startsWith("application/pdf")) return j({ ok: false, error: "Skicka application/pdf" }, 400);
      const ab = await req.arrayBuffer();
      const key = `uploads/${crypto.randomUUID()}.pdf`;
      await env.skogaiR2bucket.put(key, ab, { httpMetadata: { contentType: "application/pdf" } });
      return j({ ok: true, key });
    }

    // TODO: Process endpoint (som du redan har med analyser)
    // Här kan du klistra in din befintliga kod för /process
    // Vi lämnar den tom här för fokus på HTML/forest.jpg
    if (url.pathname === "/process" && req.method === "POST") {
      return j({ ok: true, msg: "process not implemented in this snippet" });
    }

    // Hämta PDF från R2
    if (url.pathname.startsWith("/get/")) {
      const k = decodeURIComponent(url.pathname.replace("/get/", ""));
      const o = await env.skogaiR2bucket.get(k);
      if (!o) return j({ ok: false, error: "Not found" }, 404);
      return new Response(o.body, {
        headers: { "content-type": o.httpMetadata?.contentType || "application/pdf" },
      });
    }

    // Default
    return new Response(JSON.stringify({ ok: true, msg: "UI + API running" }), {
      headers: { ...JSON_HDR, "access-control-allow-origin": "*" },
    });
  },
};

// ---------- Hjälpare ----------
function j(obj: unknown, status = 200): Response {
  return new Response(JSON.stringify(obj), {
    status,
    headers: { ...JSON_HDR, "access-control-allow-origin": "*" },
  });
}

// ---------- HTML med forest.jpg som bakgrund ----------
const HTML_PAGE = /* html */ `<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vedrik Skog och lite AI</title>
<style>
body{margin:0;font:16px/1.45 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#222}
header.hero{
  background:url("/forest.jpg") center/cover no-repeat;
  color:white;
  padding:60px 20px;
  text-align:center;
}
header.hero h1{margin:0;font-size:2.5rem;text-shadow:0 2px 6px rgba(0,0,0,0.6)}
main{max-width:900px;margin:24px auto;padding:0 16px}
fieldset{border:1px solid #ddd;padding:12px 16px;margin:16px 0;border-radius:8px}
label{margin-right:14px;display:inline-flex;align-items:center;gap:6px}
button{padding:10px 14px;border-radius:8px;border:1px solid #bbb;cursor:pointer}
.bar{height:10px;background:#eee;border-radius:8px;overflow:hidden}
.bar>div{height:100%;width:0%}
#upBar{background:#4caf50} #exBar{background:#2196f3}
pre#out{white-space:pre-wrap;background:#111;color:#eee;padding:12px;border-radius:8px}
pre#out .raw{color:#555} /* gör raw text svagare */
</style>
</head>
<body>
<header class="hero">
  <h1>Vedrik Skog och lite AI</h1>
</header>
<main>
  <fieldset><legend>1) Ladda upp PDF</legend>
    <input type="file" id="pdf" accept="application/pdf">
    <button id="btnUpload">Ladda upp</button>
    <div>Nyckel: <code id="key"></code></div>
    <div style="margin:12px 0">
      <div>Uppladdning: <span id="upPct">0%</span></div>
      <div class="bar"><div id="upBar"></div></div>
    </div>
  </fieldset>

  <fieldset><legend>2) Välj analyser</legend>
    <label><input type="checkbox" class="an" value="price_metrics" checked> Pris-metrik</label>
    <label><input type="checkbox" class="an" value="risk" checked> Risk</label>
    <button id="btnProcess">Kör extraktion + analyser</button>
  </fieldset>

  <h3>Resultat</h3>
  <pre id="out">{ "tips": "1) Ladda upp PDF, 2) Kör analyser" }</pre>
</main>

<script>
function out(o){document.getElementById('out').textContent=typeof o==='string'?o:JSON.stringify(o,null,2)}
function setUploadProgress(p){document.getElementById('upPct').textContent=Math.round(p)+'%';document.getElementById('upBar').style.width=p+'%'}

function upload(){
  const f=document.getElementById('pdf').files[0];
  if(!f){ alert('Välj PDF'); return; }
  setUploadProgress(0); out('Laddar upp...');
  const xhr = new XMLHttpRequest();
  xhr.open('POST','upload',true);
  xhr.setRequestHeader('Content-Type','application/pdf');
  xhr.upload.onprogress=e=>{
    if(e.lengthComputable) setUploadProgress((e.loaded/e.total)*100);
  };
  xhr.onload=()=>{out(xhr.responseText)};
  xhr.send(f);
}

async function processRun(){
  const key=document.getElementById('key').textContent.trim(); if(!key) return alert('Ladda upp först');
  const analyses=[...document.querySelectorAll('.an:checked')].map(x=>x.value);
  const r=await fetch('process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,analyses})});
  out(await r.json());
}

document.getElementById('btnUpload').addEventListener('click',upload);
document.getElementById('btnProcess').addEventListener('click',processRun);
</script>
</body>
</html>`;
